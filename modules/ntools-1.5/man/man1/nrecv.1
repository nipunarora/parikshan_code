.\" Man page for nrecv
.\"
.\" Copyright (C) 2008, Norbert Vegh
.\"
.\" You may distribute under the terms of the GNU General Public
.\" License Verson 2, or any later version at your option.
.\"
.\" Norbert Vegh
.\" ntools@norvegh.com
.\"
.TH nrecv 1 "April 20, 2010" "1.5"

.SH NAME
.BR "nrecv" " - the UDP/TCP receiver program of ntools"

.SH SYNOPSIS
.BR "nrecv -if " "interface " "-proto udp" "|" "tcp" " [" "-srcip" " srcip] [" "-dstip" " dstip]"
.RB "[" "-srcport" " srcport] [" "-dstport" " dstport] [" "-int" " statinterval] [" "-log" " logfile]"
.RB "[" "-statfile" " statfile] [" "-timestamp" "] [" "-delay" "] [" "-jitter" "] [" "-tos" " tos] [" "-prec" " precedence]"
.RB "[" "-percentile" "] [" "-p1" " percentile1] [" "-p2" " percentile2] [" "-p3" " percentile3]"
.RB "[" "-mcast" "]"
.PP
.BR "nrecv -f" " file"

.SH DESCRIPTION
.B nrecv
is the UDP/TCP receiver program of
.B ntools
that provides statistics about static UDP and TCP streams generated by
.BR ngen ". The program supports arbitrary number of streams"
which can be specified by filters.
The parameters can be passed either on the command line interface, or can be
placed in a config file. On the command line only one stream can be configured.
.PP
The output of the program provides the following fields for each stream:
.IP - 3
.PD 0
stream ID
.IP - 3
the number of received packets
.IP - 3
the number of lost and misordered packets
.IP - 3
the number of misordered packets
.IP - 3
L2 (Ethernet-level) rate for UDP streams, and goodput for TCP streams, both in Mbps
.IP - 3
delay in ms
.IP - 3
jitter (min delay, max delay, and difference in ms)
.IP - 3
delay percentiles in ms
.IP - 3
.RB "flags for special events: " "F " "- indicating that foreign frames were received on the stream"
.RB "(not generated by ngen), " "C " "- indicating"
that the measured delay is invalid, mostly due to clock sync problem
.PD
.PP
.B MULTICAST
.PP
Multicast receiving is supported for UDP streams with the
.B -mcast
option. If it is specified the receiver will first join the multicast group
specified with the destination address.
.PP
.B Receiving VLAN traffic
.PP
There are two options for receiving VLAN traffic. First, a regular VLAN interface can be configured with
.RB "the standard " "vconfig " "command, and that interface can be used with the " "-if " "option."
.RB "The other solution is to use the physical interface for the " "-if " "option,"
.RB "and use the " "vlan " "filter in the configuration file."
.br
.RB "Note, that if you use a VLAN interface for the " "-if " "option, then the VLAN header is not counted"
.RB "to the received bytes and rate, as it is not seen by " "nrecv" "."

.PP
.B Support for real-time Linux
.PP
.BR "nrecv " "supports the CONFIG_PREEMPT_RT kernel patch for more precise delay and jitter measurements."
.RB "With this patch " "nrecv " "can achieve consistent sub-ms resolution in the measurements."
Upon startup the program checks whether the kernel has the RT support and use it if available.
.PP
For more information about the RT patch visit the following link:
.br
https://rt.wiki.kernel.org/index.php/Main_Page

.SH OPTIONS
.TP
.BR -f " file"
The config file. No other options can be specified if a config file is used.
.TP
.BR "-proto udp" "|" "tcp"
The protocol can be either UDP or TCP.
.TP
.BR -if " interface"
The receiving interface.
.TP
.BR -srcip " srcip"
The source IP address filter.
.TP
.BR -dstip " dstip"
The destination IP address filter.
.TP
.BR -srcport " srcport"
The source port filter.
.TP
.BR -dstport " dstport"
The destination port filter.
.TP
.BR -prec " precedence"
The IP precedence value filter. Its valid range is 0..7.
.TP
.BR -tos " tos"
The IP Type of Service value filter. Its valid range is 0..255.
.TP
.BR -delay
If specified, the program measures delay.
.TP
.BR -jitter
If specified, the program measures jitter.
.TP
.BR -int " statinterval"
Sets the statistical interval in second. The program generates statistics in each
interval. The default is 1 second.
.TP
.BR -timestamp
If specified the program will timestamp each statistics line.
.TP
.BR -statfile " statfile"
If this parameter is set, the program also saves the statistics to the
given file.
.TP
.BR -log " logfile"
If this parameter is set, the program logs data about every captured packet to
the given file.
.TP
.BR -percentile
To enable delay percentile measurement. p1, p2 and p3 defines 3 different delay percentiles that can be measured for specific streams. The percentiles shall be given as floating point numbers. A 99.9 delay percentile value of 10 ms for example means that 99.9% of packets had less latency than 10 ms.
.TP
.BR -p1 " percentile1"
The first percentile value.
.TP
.BR -p2 " percentile2"
The second percentile value.
.TP
.BR -p3 " percentile3"
The third percentile value.
.TP
.BR -mcast
To enable multicast receiving.

.SH "CONFIG FILE"
The config file has two parts: a global section and a stream section.
The global section must preceed the stream section, and has the following options:
.IP "" 3
.PD 0
.BR interval " statinterval"
.IP
.BR statfile " statfile"
.IP
.BR timestamp
.IP
.BR logfile " logfile"
.IP
.BR log
.IP
.BR p1 " percentile1"
.IP
.BR p2 " percentile2"
.IP
.BR p3 " percentile3"
.PD
.PP
.BR "statinterval, timestamp, statfile, percentile, p1, p2" " and " p3 " are the same as described above."
.BR logfile " specifies the file to save packet-level logging, but"
does not enable logging for any streams. The
.BR log " option enables logging for all streams."
.PP
The stream section contains a number of stream spefications in the following format.
(The maximum number of streams is defined in
.BR defs.h ", its default value is 100.) A stream specification contains some stream settings
and some filter options. Some of the options are mandatory, some optional.
.IP "" 3
.PD 0
.B add
.IP
.B {
.IP "" 6
.PD 0
.BR "id " "id"
.IP
.BR "if " "if"
.IP
.B "log"
.IP
.B "logloss"
.IP
.BR "logdelay " "delay"
.IP
.B "percentile"
.IP
.B "delay"
.IP
.B "jitter"
.IP
.BR "vlan " "vlan"
.IP
.BR "pbits " "pbits"
.IP
.BR "srcip " "<srcip-spec>"
.IP
.BR "dstip " "<dstip-spec>"
.IP
.BR "proto udp" "|" "tcp"
.IP
.BR "prec " "prec"
.IP
.BR "tos " "tos"
.IP
.BR "srcport " "<srcport-spec>"
.IP
.BR "dstport " "<dstport-spec>"
.IP "" 3
.PD
.B }
.PP
Anything after a hashmark (#) on a line is treated as comment, and ignored.
.PP
.BR id " sets the name for the stream that is used in the statistics."
.BR if " specifies the interface where this stream is to be captured."
.BR log " enables logging for all packets of the stream."
.BR logloss " enables logging only for lost frames for the stream.
.BR logdelay " will enable logging for those packets in the stream that have bigger delay than the specified value.
.BR delay " and " jitter " enables delay and jitter measurement for the stream."
The rest are filters that the packet must match to belong to the stream.
.BR "vlan " " specifies on which 802.1q VLAN the packets shall be captured."
.BR "pbits " "filters packets with a specific 802.1p p-bits."
.PP
.B IP AND PORT SPECS
.PP
The
.BR srcip-spec " and " dstip-spec " can be a simple IP address, or an address range"
in the following format:
.IP "" 3
.PD 0
.BR range
.IP
.B {
.IP "" 6
.PD 0
.BR "first " "first"
.IP
.BR "inc " "inc"
.IP
.BR "num " "num"
.IP "" 3
.PD
.B }
.PP
.BR first " is the first IP address in the range."
.BR inc " is also in IP address notation. The range is created by adding
.BR inc " successively to the " first " ip address. The range contains"
.BR num " number of addresses."
.PP
The
.BR srcport-spec " and " dstport-spec " can be a simple port number, or a port range."
It has exactly the same format as an address range, expect that here
.BR first " and " inc " are simple numbers."
.PP
If an address/port range is specified, then the packet matches the filter
if its address/port is within the given range.
.PP
.SH RESTRICTIONS
.PP
Only UDP streams can have
.BR "vlandid, pbits, srcip, dstip, prec, tos " "and " "srcport " "filters. The"
.BR proto " filter is mandatory, and TCP streams must have " dstport " filter."
.PP
Ranges are not supported for TCP streams.

.SH "LOG FILE"
The log file contains one line for each captured packet. The line has the
following fields:
.IP - 3
.PD 0
timestamp
.IP - 3
stream ID
.IP - 3
status: OK (normal frame), LOSS (frame loss), DUPLIC (frame duplication), MISORD (frame misorder)
.IP - 3
the sequence number placed by
.B ngen
.IP - 3
number of lost frames before this one
.IP - 3
Frame length (with Ethernet overhead)
.IP - 3
.PD
the measured delay in ms (CLOCK indicates clock sync problem)

.SH "NOTES"
You must be root to capture UDP streams.
.PP
Note that the accuracy of the measurements depends on the CPU speed, and also the CPU load.
It is advisable to tune the PC for performance, and shut down all unnecessary daemons/processes.
It is also recommended to verify that DMA is enabled on the hard drive with the "hdparm /dev/hda" command.
.PP
For delay measurements the clock of the machines running
.BR "ngen " "and " "nrecv " "must be synchronized. An other way is to"
run both program on the same machine, and use the
.BR ngen " in " lowlevel " mode."

.SH "EXAMPLES"
To capture a UDP stream on the eth0 interface at port 8000:
.IP "" 3
nrecv -if eth0 -proto udp -dstport 8000
.PP
A config file to capture two streams, on the second one we emulate an address range of
10.0.50.10, 10.0.50.12 ... 10.0.50.28:
.IP "" 3
.PD 0
add
.IP
{
.IP "" 6
.PD 0
id stream_1
.IP
if eth0
.IP
proto udp
.IP
dstport 8000
.IP "" 3
.PD 0
}
.IP
add
.IP
{
.IP "" 6
.PD 0
id stream_2
.IP
if eth1
.IP
proto udp
.IP
dstip range
.IP
{
.IP "" 9
.PD 0
first 10.0.50.10
.IP
inc 0.0.0.2
.iP
num 10
.IP "" 6	
.PD 0
}
.IP
dstport 9000
.IP "" 3
.PD
}

.SH "SEE ALSO"
.B ntools(1), ngen(1).

.SH AUTHOR
Norbert Vegh, ntools@norvegh.com

.SH COPYRIGHT
.BR "nrecv" " is (C) 2002-2010 Norbert Vegh"
.br
The program was originally developed in Telia Research AB.
.PP
This program is free software; you can redistribute it and/or
modify it under the terms of the GNU General Public License
as published by the Free Software Foundation;
either version 2 of the License, or (at your	option)
any later version.
.PP
.PP
This software is provided without any warranty.
